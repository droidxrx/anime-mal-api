"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("superagent"),t=require("crypto-js");function _interopNamespace(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var n=_interopNamespace(e);function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function base64URL(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function pkceChallenge(e){var n=function generateRandomString(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=0;r<e;r++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}(e);return{code_challenge:base64URL(t.SHA256(n).toString(t.enc.Base64)),code_verifier:n}}var r=function(){function oauth2(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;_classCallCheck(this,oauth2),_defineProperty(this,"client_id",void 0),_defineProperty(this,"client_secret",void 0),_defineProperty(this,"redirect_uri",void 0),_defineProperty(this,"baseurl","https://myanimelist.net/v1/oauth2"),_defineProperty(this,"urlRedirect","".concat(this.baseurl,"/authorize")),_defineProperty(this,"urlToken","".concat(this.baseurl,"/token")),this.client_id=e,this.client_secret=t}return _createClass(oauth2,[{key:"generatePKCEChallenge",value:function generatePKCEChallenge(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:43;return e<43?console.log("Length Minimal 43"):e>128?console.log("Length Maximal 128"):pkceChallenge(e)}},{key:"verifyPKCEChallenge",value:function verifyPKCEChallenge(e,n){return function verifyChallenge(e,n){return base64URL(t.SHA256(e).toString(t.enc.Base64))===n}(e,n)}},{key:"urlAuthorize",value:function urlAuthorize(e,t){var n=t?"&redirect_uri=".concat(t):"";return this.redirect_uri=t,"".concat(this.urlRedirect,"?response_type=code&client_id=").concat(this.client_id,"&code_challenge=").concat(e,"&code_challenge_method=plain").concat(n)}},{key:"accessToken",value:function accessToken(e,t){var r=this,i={client_id:this.client_id,client_secret:this.client_secret,code:e,code_verifier:t,grant_type:"authorization_code"};return this.redirect_uri&&Object.assign(i,{redirect_uri:this.redirect_uri}),new Promise((function(e,t){n.post(r.urlToken).send(i).type("application/x-www-form-urlencoded").then((function(t){return e(t.body)})).catch((function(e){return t(JSON.parse(e.response.text))}))}))}},{key:"refreshToken",value:function refreshToken(e){var t=this,r={client_id:this.client_id,client_secret:this.client_secret,refresh_token:e,grant_type:"refresh_token"};return new Promise((function(e,i){n.post(t.urlToken).send(r).type("application/x-www-form-urlencoded").then((function(t){return e(t.body)})).catch((function(e){return i(JSON.parse(e.response.text))}))}))}}]),oauth2}();function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(e){return typeof e}:function _typeof(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var i=function(){function baseclass(e){_classCallCheck(this,baseclass),_defineProperty(this,"urlBase","https://api.myanimelist.net/v2"),_defineProperty(this,"token",void 0),_defineProperty(this,"agent",void 0),this.token=e,this.agent=n.agent().auth(this.token,{type:"bearer"})}return _createClass(baseclass,[{key:"callback",value:function callback(e,t,n){e.then((function(e){return t({status:!0,result:e.body})})).catch((function(e){return n(Object.assign({status:!1},JSON.parse(e.response.text)))}))}},{key:"get",value:function get(e,t){var n=this,r="".concat(this.urlBase).concat(e),i=this.agent.get(r).query(t);return new Promise((function(e,t){return n.callback(i,e,t)}))}},{key:"del",value:function del(e,t){var n=this,r="".concat(this.urlBase,"/").concat(e,"/").concat(t,"/my_list_status"),i=this.agent.delete(r);return new Promise((function(e,t){return n.callback(i,e,t)}))}},{key:"put",value:function put(e,t,n){var r=this,i="".concat(this.urlBase,"/").concat(e,"/").concat(t,"/my_list_status"),a=this.agent.put(i).query(n).type("application/x-www-form-urlencoded");return new Promise((function(e,t){return r.callback(a,e,t)}))}}]),baseclass}(),a={animeFull:["id","title","main_picture","alternative_titles","start_date","end_date","synopsis","mean","rank","popularity","num_list_users","num_scoring_users","nsfw","genres","created_at","updated_at","media_type","status","my_list_status","num_episodes","start_season","broadcast","source","average_episode_duration","rating","studios","pictures","background","related_anime","related_manga","recommendations","statistics"],animeInList:["id","title","main_picture","alternative_titles","start_date","end_date","synopsis","mean","rank","popularity","num_list_users","num_scoring_users","nsfw","genres","created_at","updated_at","media_type","status","my_list_status","num_episodes","start_season","broadcast","source","average_episode_duration","rating","studios"]},s=function(){function utils_anime(){_classCallCheck(this,utils_anime),_defineProperty(this,"months",["winter","spring","summer","fall"])}return _createClass(utils_anime,[{key:"getSeasonForNumberMonth",value:function getSeasonForNumberMonth(e){return e<3?"winter":e>2&&e<6?"spring":e>5&&e<9?"summer":"fall"}},{key:"checkIfMonthIsValid",value:function checkIfMonthIsValid(e){return-1!=this.months.indexOf(e)}}]),utils_anime}();function _createSuper$4(e){var t=function _isNativeReflectConstruct$4(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var n,r=_getPrototypeOf(e);if(t){var i=_getPrototypeOf(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _possibleConstructorReturn(this,n)}}var o=function(e){_inherits(anime,i);var t=_createSuper$4(anime);function anime(e){var n;return _classCallCheck(this,anime),_defineProperty(_assertThisInitialized(n=t.call(this,e)),"utils",new s),n}return _createClass(anime,[{key:"animeId",value:function animeId(e){var t=e.id,n=e.fields,r=void 0===n?a.animeFull:n;return this.get("/anime/".concat(t),{fields:r.toString()})}},{key:"animeSearch",value:function animeSearch(e){var t=e.q,n=e.offset,r=void 0===n?0:n,i=e.limit,s=void 0===i?100:i,o=e.fields,u={q:t,limit:s,offset:r,fields:(void 0===o?a.animeInList:o).toString()};return this.get("/anime",u)}},{key:"animeRanking",value:function animeRanking(e){var t=e.ranking_type,n=void 0===t?"all":t,r=e.offset,i=void 0===r?0:r,s=e.limit,o=void 0===s?100:s,u=e.fields,c={ranking_type:n,limit:o,offset:i,fields:(void 0===u?a.animeInList:u).toString()};return this.get("/anime/ranking",c)}},{key:"animeSeasonal",value:function animeSeasonal(e){var t=e.year,n=void 0===t?(new Date).getFullYear():t,r=e.season,i=void 0===r?this.utils.getSeasonForNumberMonth((new Date).getMonth()):r,s=e.offset,o=void 0===s?0:s,u=e.limit,c=void 0===u?100:u,l=e.sort,f=void 0===l?"":l,_=e.fields,d={year:n,season:i,offset:o,limit:c,sort:f,fields:(void 0===_?a.animeInList:_).toString()};return this.get("/anime/season/".concat(n,"/").concat(i),d)}},{key:"animeSuggestions",value:function animeSuggestions(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:a.animeInList,r={offset:e,limit:t,fields:n.toString()};return this.get("/anime/suggestions",r)}}]),anime}(),u=["status","score","num_watched_episodes","is_rewatching","start_date","finish_date","priority","num_times_rewatched","rewatch_value","tags","updated_at","id","title","main_picture","alternative_titles","start_date","end_date","synopsis","mean","rank","popularity","num_list_users","num_scoring_users","nsfw","genres","created_at","updated_at","media_type","status","my_list_status","num_episodes","start_season","broadcast","source","average_episode_duration","rating","studios"];function _createSuper$3(e){var t=function _isNativeReflectConstruct$3(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var n,r=_getPrototypeOf(e);if(t){var i=_getPrototypeOf(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _possibleConstructorReturn(this,n)}}var c=function(e){_inherits(anime_list,i);var t=_createSuper$3(anime_list);function anime_list(e){return _classCallCheck(this,anime_list),t.call(this,e)}return _createClass(anime_list,[{key:"getList",value:function getList(e){var t=e.user_name,n=void 0===t?"@me":t,r=e.offset,i=void 0===r?0:r,a=e.limit,s=void 0===a?100:a,o=e.fields,c={offset:i,limit:s,fields:(void 0===o?u:o).toString()};return this.get("/users/".concat(n,"/animelist"),c)}},{key:"deleteList",value:function deleteList(e){return this.del("anime",e)}},{key:"updateList",value:function updateList(e,t){return this.put("anime",e,t)}}]),anime_list}(),l={mangaFull:["id","title","main_picture","alternative_titles","start_date","end_date","synopsis","mean","rank","popularity","num_list_users","num_scoring_users","nsfw","genres","created_at","updated_at","media_type","status","my_list_status","num_volumes","num_chapters","authors","pictures","background","related_anime","related_manga","recommendations","serialization"],mangaInList:["id","title","main_picture","alternative_titles","start_date","end_date","synopsis","mean","rank","popularity","num_list_users","num_scoring_users","nsfw","genres","created_at","updated_at","media_type","status","my_list_status","num_volumes","num_chapters","authors"]};function _createSuper$2(e){var t=function _isNativeReflectConstruct$2(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var n,r=_getPrototypeOf(e);if(t){var i=_getPrototypeOf(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _possibleConstructorReturn(this,n)}}var f=function(e){_inherits(manga,i);var t=_createSuper$2(manga);function manga(e){return _classCallCheck(this,manga),t.call(this,e)}return _createClass(manga,[{key:"mangaId",value:function mangaId(e){var t=e.id,n=e.fields,r={fields:(void 0===n?l.mangaFull:n).toString()};return this.get("/manga/".concat(t),r)}},{key:"mangaSearch",value:function mangaSearch(e){var t=e.q,n=e.offset,r=void 0===n?0:n,i=e.limit,a=void 0===i?100:i,s=e.fields,o={q:t,limit:a,offset:r,fields:(void 0===s?l.mangaInList:s).toString()};return this.get("/manga",o)}},{key:"mangaRanking",value:function mangaRanking(e){var t=e.ranking_type,n=void 0===t?"all":t,r=e.offset,i=void 0===r?0:r,a=e.limit,s=void 0===a?100:a,o=e.fields,u={ranking_type:n,limit:s,offset:i,fields:(void 0===o?l.mangaInList:o).toString()};return this.get("/manga/ranking",u)}}]),manga}(),_=["status","score","num_volumes_read","num_chapters_read","is_rereading","start_date","finish_date","priority","num_times_reread","reread_value","tags","updated_at","id","title","main_picture","alternative_titles","start_date","end_date","synopsis","mean","rank","popularity","num_list_users","num_scoring_users","nsfw","genres","created_at","updated_at","media_type","status","my_list_status","num_volumes","num_chapters","authors"];function _createSuper$1(e){var t=function _isNativeReflectConstruct$1(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var n,r=_getPrototypeOf(e);if(t){var i=_getPrototypeOf(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _possibleConstructorReturn(this,n)}}var d=function(e){_inherits(manga_list,i);var t=_createSuper$1(manga_list);function manga_list(e){return _classCallCheck(this,manga_list),t.call(this,e)}return _createClass(manga_list,[{key:"getList",value:function getList(e){var t=e.user_name,n=void 0===t?"@me":t,r=e.offset,i=void 0===r?0:r,a=e.limit,s=void 0===a?100:a,o=e.fields,u={offset:i,limit:s,fields:(void 0===o?_:o).toString()};return this.get("/users/".concat(n,"/mangalist"),u)}},{key:"deleteList",value:function deleteList(e){return this.del("manga",e)}},{key:"updateList",value:function updateList(e,t){return this.put("manga",e,t)}}]),manga_list}(),p=["id","name","picture","gender","birthday","location","joined_at","anime_statistics","time_zone","is_supporter"];function _createSuper(e){var t=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var n,r=_getPrototypeOf(e);if(t){var i=_getPrototypeOf(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _possibleConstructorReturn(this,n)}}var m=function(e){_inherits(user,i);var t=_createSuper(user);function user(e){return _classCallCheck(this,user),t.call(this,e)}return _createClass(user,[{key:"me",value:function me(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:p;return this.get("/users/@me",{fields:e.toString()})}}]),user}();window&&Object.assign(window,{MAL_API:{OAUTH2:r,ANIME:o,ANIME_LIST:c,MANGA:f,MANGA_LIST:d,USER:m}}),exports.MAL_API_ANIME=o,exports.MAL_API_ANIME_LIST=c,exports.MAL_API_MANGA=f,exports.MAL_API_MANGA_LIST=d,exports.MAL_API_USER=m,exports.MAL_OAUTH2=r;
